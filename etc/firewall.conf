#!/bin/sh
set -e
# /etc/firewall.conf — Упрощённый: Только static init (tables + reload PF)
# Динамика — полностью в OnConnect/OnDisconnect

PFCTL="/sbin/pfctl -q"
DNCTL="/sbin/dnctl"  # Не используется, но на всякий
# FwCMD="/sbin/ipfw -q"

# Flush PF anchors (для динамики; не трогаем основной pf.conf)
${PFCTL} -Fa

# Static tables (как в старом; биллинг добавит dynamic)
# local_nets (аналог table(2): 172.16.32.0/19)
${PFCTL} -t local_nets -T replace -f /dev/stdin <<EOF
172.16.32.0/19
EOF

# ext_ips (аналог table(9): 31.41.108.1/32 + local)
${PFCTL} -t ext_ips -T replace -f /dev/stdin <<EOF
172.16.32.0/19
31.41.108.1/32
EOF

# internal_from (table(60): 192.168.168.160/32)
${PFCTL} -t internal_from -T replace -f /dev/stdin <<EOF
192.168.168.160/32
EOF

# Убрано (динамика в OnConnect: dnctl pipe + pfctl -a shaper pass dummynet pipe ID).
#${FwCMD} add 12001 pipe tablearg ip from not me to table\(4\) via lagg0 out
#${FwCMD} add 12000 pipe tablearg ip from table\(3\) to not me via lagg0 in

# Убрано (перенесено в pf.conf)
#security
#${FwCMD} add 1 deny ip from any to any dst-port 445
#${FwCMD} add 3 deny ip6 from any to any
#${FwCMD} add 101 allow all from 192.168.168.10 to any
#${FwCMD} add 101 allow all from any to 192.168.168.10
# allow access to my http for all
#${FwCMD} add  62000 allow tcp from any to me dst-port 80
#${FwCMD} add  62000 allow tcp from me to any src-port 80

# Убрано (перенесено в pf.conf)
#Redir to block page
#ipfw add 88 fwd 127.0.0.1,81 ip  from "table(47)" to not me dst-port 1-65535 in via lagg0
#ipfw add 799 allow ip from "table(60)" to "table(66)" in via lagg0
#ipfw add 800 fwd 127.0.0.1,88 ip from any to "table(66)" in via lagg0
#Allow to google DNS
#ipfw add 5  allow ip from 8.8.8.8,8.8.4.4 to any
#ipfw add 5  allow ip from any to 8.8.8.8,8.8.4.4


# Reload основной PF
${PFCTL} -f /etc/pf.conf
${PFCTL} -e

# Netflow (softflowd на LAN/ix1; запускать здесь или в rc.local)
if ! pgrep -f "softflowd.*ix1" >/dev/null 2>&1; then
    /usr/local/sbin/softflowd -i ix1 -n 192.168.168.10:42111
fi
