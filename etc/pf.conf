set limit states 16000000
set optimization aggressive
set limit src-nodes 160000
set limit table-entries 160000
set skip on lo0




#no lagg
#rdr on em0 proto tcp from any to 31.41.108.3 port 8877 -> 192.168.168.10 port 80
#rdr on em0 proto tcp from any to 31.41.108.3 port 8822 -> 192.168.168.10 port 22
#rdr on em0 proto tcp from any to 31.41.108.3 port 42112 -> 192.168.168.10 port 42111
#rdr on em0 proto tcp from any to 31.41.108.3 port 8880 -> 192.168.168.235 port 80
#rdr on em0 proto tcp from any to 31.41.108.3 port 443 -> 192.168.168.235 port 443
#rdr on em0 proto tcp from 193.107.128.124 to 31.41.108.3 port 2222 -> 192.168.168.252 port 22
#rdr on em0 proto tcp from 31.41.109.0/24 to 31.41.108.3 port 8383 -> 192.168.168.252 port 8006
#rdr on em0 proto tcp from 31.41.109.0/24 to 31.41.108.3 port 8989 -> 192.168.168.2 port 8291
#nat on em0 from <local1> to any -> 31.41.107.0/24 source-hash

#prepare to lagg

#rdr on vlan270 proto tcp from any to 85.115.202.3 port 8877 -> 192.168.168.10 port 80
#rdr on vlan270 proto tcp from any to 85.115.202.3 port 8822 -> 192.168.168.10 port 22
#rdr on vlan270 proto tcp from any to 85.115.202.3 port 8882 -> 192.168.168.5 port 22
rdr on vlan270 proto tcp from any to 85.115.202.3 port 42112 -> 192.168.168.10 port 42111
rdr on vlan270 proto tcp from any to 85.115.202.3 port 8880 -> 192.168.168.253 port 80
rdr on vlan270 proto tcp from any to 85.115.202.3 port 8292 -> 192.168.168.222 port 8292
#rdr on vlan270 proto tcp from any to 31.41.108.3 port 443 -> 192.168.168.235 port 443
#rdr on vlan270 proto tcp from 193.107.128.124 to 85.115.202.3 port 2222 -> 192.168.168.252 port 22
rdr on vlan270 proto tcp from 31.41.109.0/24 to 85.115.202.3 port 8383 -> 192.168.168.252 port 8006
rdr on vlan270 proto tcp from 31.41.109.0/24 to 85.115.202.3 port 8989 -> 192.168.168.2 port 8291

#nat on lagg1 from <local1> to any -> 31.41.107.0/24 source-hash
#nat on lagg1 from <local1> to any -> 31.41.108.3/32 source-hash

rdr on vlan270 proto tcp from any to 85.115.202.3 port 8122 -> 192.168.168.8 port 22

#pass in on lagg0 from 172.16.42.19 to any route-to 100.127.255.77
#pass in quick on lagg0 route-to vlan3100 100.127.255.77 from 172.16.42.19
#rdr on lagg0 from 172.16.42.19 to any -> 100.127.255.77
#block in quick on lagg0 from 172.16.42.19/32
#set skip on lagg0
#set route to 100.127.255.77


#nat on vlan3100 from 172.16.36.167 to any tag MIR -> (vlan3100)
#no nat on vlan270 from 172.16.36.167/32 to any
#nat on vlan270 from <local1> to ! 4.2.2.2 -> 85.115.202.32/27 source-hash 



#pass out on vlan3100 route-to (vlan3100 100.127.255.77) tagged MIR

#nat on lagg1 from <local1> to any -> 31.41.108.3/32 source-hash
#pass in route-to vlan3100 from 172.16.42.19 to any no state
#pass in route-to 100.127.255.77 from 172.16.37.92 to any no state
#pass in on lagg0 route-to (vlan3100 100.127.255.77)from 172.16.36.167 to any no state
#pass in on lagg0 route-to (vlan3100 100.127.255.77)from 172.16.36.167 to any
#pass out on vlan270 route-to (vlan3100 100.127.255.77)from 172.16.36.167 to any
#pass out on vlan3100 route-to (vlan270 85.115.202.1)from 85.115.202.3 to any no state
#pass out on vlan3100 route-to (vlan270 85.115.202.1)from 85.115.202.8 to any no state

#NAT switch
#nat on vlan270 from <local1> to any -> 85.115.202.32/27 source-hash 

#MIRANDA CG_NAT
#pass out on vlan270 route-to (vlan3100 100.127.255.77)from <local1> to ! 85.115.202.0/24 no state
pass out on vlan270 route-to (vlan4050 172.31.255.1)from <local1> to ! 85.115.202.0/24 no state


table <local1> { 172.16.0.0/12, 192.168.0.0/16, 10.123.0.0/24 }
#table <local1> { except 172.16.36.167/32 }

#pass in route-to vlan3100 from 172.16.42.19 to any no state


