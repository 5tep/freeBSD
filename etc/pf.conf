# /etc/pf.conf — Полная миграция с IPFW на PF + Dummynet (FreeBSD 14.2)
# Адаптировано под новую схему: ix0=WAN (vlan270/4050), ix1=LAN, re0=mgmt (vlan4000)
# Limits/optimizations (как в старом)
set limit states 16000000
set optimization aggressive
set limit src-nodes 160000
set limit table-entries 160000
set skip on { lo0, vlan4000 }  # Skip на loopback и mgmt

# Макросы/таблицы (persist — не flush при reload)
ext_if = "vlan270"       # WAN основной (85.115.202.3/28)
int_if = "ix1"           # LAN (10.10.10.10/24, пользователи)
mgmt_if = "vlan4000"     # Mgmt на re0 (192.168.168.9/24, SSH)
allowed_ips = "{ 172.16.32.236, 172.16.32.61 }"
billing_net = "10.123.0.0/16"
ext_subnet = "31.41.109.0/24"  # Для rdr

# Dynamic tables (persist — сохраняются)
table <local1> persist { 172.16.0.0/12, 192.168.0.0/16, 10.123.0.0/24 }
table <users_in> persist { }   # Аналог table(3): from users (up)
table <users_out> persist { }  # Аналог table(4): to users (down)
table <block_users> persist { } # Аналог table(47): blocked (redirect to 81)
table <internal_from> persist { 192.168.168.160/32 } # table(60)
table <internal_to> persist { }   # table(66) — null?
table <local_nets> persist { }   # Аналог table(2)
table <ext_ips> persist { }   # Аналог table(9)
table <internal_from> persist { }   # Аналог table(60)

# Dummynet anchor (динамика через OnConnect/OnDisconnect скрипты)
anchor "shaper"
# load anchor "shaper" from "/etc/pf_shaper.rules"

# === BLOCKS ===
block in quick proto tcp to any port 445  # Deny SMB
block quick proto ipv6  # Deny IPv6

# === ALLOWS ===
# DNS (Google)
pass in quick proto { udp, tcp } from { 8.8.8.8, 8.8.4.4 } to port 53
pass out quick proto { udp, tcp } to { 8.8.8.8, 8.8.4.4 } port 53

# HTTP (веб-интерфейс)
pass in quick proto tcp to port 80
pass out quick proto tcp from port 80

# HTTPS (ДОБАВЛЕНО: базовый pass для 443)
pass in quick proto tcp to port 443
pass out quick proto tcp from port 443

# Management (SSH на mgmt_if)
pass in quick on $mgmt_if proto tcp to port 22
pass out quick on $mgmt_if proto tcp from $mgmt_if to any port 22

# Белый список
pass quick from $allowed_ips to any
pass quick from any to $allowed_ips

# Internal allow (table 60 → 66)
pass in quick on $int_if from <internal_from> to <internal_to>

# === FORWARD/RDR (из старого IPFW + pf.conf) ===
# Block page redirect (table(47) → 81)
rdr pass on $ext_if proto tcp from <block_users> to any port 1:65535 -> 127.0.0.1 port 81

# Billing portal (billing_net → 8877)
rdr pass on $ext_if proto tcp from $billing_net to any port 1:65535 -> 127.0.0.1 port 8877

# Internal forward (table(66) → 88)
rdr pass in on $int_if to <internal_to> -> 127.0.0.1 port 88

# Другие rdr (из старого pf.conf, адаптировано под ext_if)
rdr on $ext_if proto tcp from any to 85.115.202.3 port 42112 -> 192.168.168.10 port 42111
rdr on $ext_if proto tcp from any to 85.115.202.3 port 8880 -> 192.168.168.253 port 80
rdr on $ext_if proto tcp from any to 85.115.202.3 port 8292 -> 192.168.168.222 port 8292
rdr on $ext_if proto tcp from $ext_subnet to 85.115.202.3 port 8383 -> 192.168.168.252 port 8006
rdr on $ext_if proto tcp from $ext_subnet to 85.115.202.3 port 8989 -> 192.168.168.2 port 8291
rdr on $ext_if proto tcp from any to 85.115.202.3 port 8122 -> 192.168.168.8 port 22

# HTTPS rdr (ДОБАВЛЕНО: из старого, закомментированного — redirect to internal 443)
#rdr on $ext_if proto tcp from any to 85.115.202.3 port 443 -> 192.168.168.235 port 443

# === SHAPING (динамический: OnConnect/OnDisconnect добавляют per-IP pass в anchor) ===
# Базовый placeholder: Трафик users → pipes (скрипты attach'ят)
pass in quick on $int_if from <users_in> to ! $int_if  # Up (in from LAN)
pass out quick on $ext_if to <users_out>  # Down (out to WAN)

# === NAT ===
nat on $ext_if from <local1> to any -> ($ext_if)  # Основной NAT (LAN → WAN)

# MIRANDA CG_NAT (как в старом; route-to на vlan4050 для !85.115.202.0/24)
pass out on $ext_if route-to (vlan4050 172.31.255.1) from <local1> to ! 85.115.202.0/24 no state

block all